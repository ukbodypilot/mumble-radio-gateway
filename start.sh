#!/bin/bash
# Start Broadcastify streaming - ROBUST VERSION

echo "=========================================="
echo "Starting Broadcastify Stream"
echo "=========================================="
echo ""

# Cleanup function
cleanup() {
    echo ""
    echo "Cleaning up..."
    if [ ! -z "$DARKICE_PID" ]; then
        kill $DARKICE_PID 2>/dev/null
        echo "  Stopped Darkice"
    fi
    if [ ! -z "$FFMPEG_PID" ]; then
        kill $FFMPEG_PID 2>/dev/null
        echo "  Stopped FFmpeg"
    fi
    rm -f /tmp/darkice_audio 2>/dev/null
    sudo modprobe -r snd-aloop 2>/dev/null
    echo "Done"
    exit
}

trap cleanup INT TERM

# Check if running as root
if [ "$EUID" -eq 0 ]; then
    echo "⚠ Warning: Running as root may cause permission issues"
    echo ""
fi

# Cache sudo credentials once up front (avoids repeat password prompts)
sudo -v

# 1. Kill any existing processes
echo "[1/7] Checking for existing processes..."
pkill -9 darkice 2>/dev/null && echo "  Killed existing Darkice"
pkill -9 ffmpeg 2>/dev/null && echo "  Killed existing FFmpeg"
sleep 1

# Also kill any Python gateway processes (just in case)
pkill -9 -f "mumble_radio_gateway" 2>/dev/null && echo "  Killed existing gateway"
sleep 1

# 2. Unload and reload ALSA loopback (fresh start)
echo "[2/7] Resetting ALSA loopback..."
sudo modprobe -r snd-aloop 2>/dev/null
sleep 1
sudo modprobe snd-aloop
if [ $? -ne 0 ]; then
    echo "  ✗ Failed to load ALSA loopback"
    exit 1
fi
sleep 2  # Wait for device to be ready
echo "  ✓ ALSA loopback loaded"

# Verify device exists
if ! aplay -l 2>/dev/null | grep -q "Loopback"; then
    echo "  ⚠ Warning: Loopback device not visible in aplay -l"
fi

# 3. Reset AIOC USB device (clears stale audio output state)
echo "[3/7] Resetting AIOC USB device..."
AIOC_USB=""
for d in /sys/bus/usb/devices/*/product; do
    if grep -qi "all-in-one" "$d" 2>/dev/null; then
        AIOC_USB="$(dirname "$d")"
        break
    fi
done
if [ -n "$AIOC_USB" ] && [ -f "$AIOC_USB/authorized" ]; then
    echo "  Found AIOC at $AIOC_USB"
    if [ -w "$AIOC_USB/authorized" ]; then
        echo 0 > "$AIOC_USB/authorized"
        sleep 1
        echo 1 > "$AIOC_USB/authorized"
    else
        # Needs root — reuse the sudo credential already cached from modprobe above
        sudo sh -c "echo 0 > $AIOC_USB/authorized && sleep 1 && echo 1 > $AIOC_USB/authorized"
    fi
    sleep 2  # Wait for USB re-enumeration
    echo "  ✓ AIOC USB reset complete"
else
    echo "  ⚠ AIOC USB device not found (skipping reset)"
fi

# 4. Create named pipe
echo "[4/7] Creating named pipe..."
# Force remove old pipe (even if busy)
rm -f /tmp/darkice_audio 2>/dev/null
# Kill any processes using it
fuser -k /tmp/darkice_audio 2>/dev/null
sleep 1
# Create fresh pipe
mkfifo /tmp/darkice_audio
chmod 666 /tmp/darkice_audio
echo "  ✓ Pipe created: /tmp/darkice_audio"

# 5. Start Darkice with visible output
echo "[5/7] Starting Darkice..."
echo "  (Darkice output will be shown below)"
echo "  ----------------------------------------"

# Start Darkice in background but capture output
darkice -c /etc/darkice.cfg > /tmp/darkice.log 2>&1 &
DARKICE_PID=$!

# Wait and check if it started successfully
sleep 4

if ! ps -p $DARKICE_PID > /dev/null 2>&1; then
    echo "  ----------------------------------------"
    if grep -qi "forbidden\|mountpoint occupied\|maximum sources" /tmp/darkice.log 2>/dev/null; then
        echo "  ⚠ Darkice: feed already live on another server — continuing without streaming"
        echo "  (Broadcastify mountpoint is occupied; local audio bridge will still run)"
        DARKICE_PID=""
        export GATEWAY_FEED_OCCUPIED=1
    else
        echo "  ✗ Darkice FAILED to start!"
        echo ""
        echo "Error output:"
        cat /tmp/darkice.log
        echo ""
        echo "Common fixes:"
        echo "  1. Check /etc/darkice.cfg has: device = hw:Loopback,1,0"
        echo "  2. Check bitrate matches Broadcastify (usually 16)"
        echo "  3. Check Broadcastify password is correct"
        echo "  4. Run: sudo modprobe -r snd-aloop && sudo modprobe snd-aloop"
        cleanup
    fi
else
    # Show first few lines of Darkice output
    head -n 10 /tmp/darkice.log
    echo "  ----------------------------------------"
    echo "  ✓ Darkice running (PID: $DARKICE_PID)"
    echo "  Full log: /tmp/darkice.log"
fi

# 6. Start FFmpeg bridge with auto-restart
echo "[6/7] Starting FFmpeg bridge..."
(
    while true; do
        ffmpeg -loglevel error -f s16le -ar 48000 -ac 1 -i /tmp/darkice_audio \
               -f alsa hw:Loopback,0,0 2>&1
        sleep 1
    done
) > /tmp/ffmpeg.log 2>&1 &
FFMPEG_PID=$!
sleep 2

if ! ps -p $FFMPEG_PID > /dev/null; then
    echo "  ✗ FFmpeg failed to start!"
    cat /tmp/ffmpeg.log
    cleanup
fi

echo "  ✓ FFmpeg bridge running (PID: $FFMPEG_PID)"

# 7. Start Gateway
echo "[7/7] Starting gateway..."
echo ""

# Find the gateway file - ONLY in same directory as this script
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
GATEWAY_FILE="$SCRIPT_DIR/mumble_radio_gateway.py"

if [ ! -f "$GATEWAY_FILE" ]; then
    echo "✗ Gateway file not found!"
    echo "  Expected: $GATEWAY_FILE"
    echo "  Make sure mumble_radio_gateway.py is in the SAME directory as start.sh"
    cleanup
    exit 1
fi

echo "Using: $GATEWAY_FILE"
echo ""
echo "=========================================="
echo "All components started successfully!"
echo "=========================================="
echo "  Darkice:  ${DARKICE_PID:+"PID $DARKICE_PID (log: /tmp/darkice.log)"}${DARKICE_PID:-"disabled (mountpoint occupied)"}"
echo "  FFmpeg:   PID $FFMPEG_PID (log: /tmp/ffmpeg.log)"
echo "  Gateway:  Starting now..."
echo ""
echo "Press Ctrl+C to stop everything"
echo ""
sleep 2

# Start gateway (this will block)
python3 "$GATEWAY_FILE"

# If gateway exits, cleanup
cleanup
